<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Keuangan V19</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- HTML2Canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: '#0B6EF6',
                        accent: '#00C48C',
                        dark: '#0F1724',
                        mid: '#1F2937',
                        bg: '#F8FAFC',
                        magic: '#7C3AED',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #e2e8f0; color: #0F1724; overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; }
        #app-container { max-width: 480px; margin: 0 auto; background: #fff; height: 100vh; position: relative; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .btn-press { transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-press:active { transform: scale(0.92); }

        /* Modal Transitions */
        .modal-enter { opacity: 0; pointer-events: none; }
        .modal-enter .modal-content { transform: translateY(100%); }
        .modal-active { opacity: 1; pointer-events: auto; }
        .modal-active .modal-content { transform: translateY(0); }
        .transition-modal { transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        .layout-fixed { flex-shrink: 0; } 
        .layout-scroll { flex-grow: 1; overflow-y: auto; }
        
        /* Custom Radio Style */
        .radio-box:checked + div { border-color: #0B6EF6; background-color: #EFF6FF; }
        .radio-box:checked + div .radio-indicator { border-color: #0B6EF6; background-color: #0B6EF6; }
    </style>
</head>
<body>

<div id="app-container">
    
    <!-- HEADER -->
    <header class="h-14 flex-none flex items-center justify-between px-4 bg-white border-b border-gray-100 z-30">
        <button class="p-2 btn-press text-gray-600" onclick="toggleDrawer(true)">
            <i class="ph ph-list text-2xl"></i>
        </button>
        <h1 id="header-title" class="font-bold text-base text-dark">Dashboard</h1>
        <button class="p-2 btn-press group relative text-gray-600" onclick="openAIModal()">
            <div class="absolute inset-0 bg-magic/10 rounded-full scale-0 group-hover:scale-100 transition-transform"></div>
            <i class="ph ph-sparkle text-2xl text-magic"></i>
        </button>
    </header>

    <!-- DRAWER -->
    <div id="drawer-overlay" class="fixed inset-0 bg-black/50 z-[60] hidden transition-opacity opacity-0" onclick="toggleDrawer(false)"></div>
    <div id="drawer-menu" class="fixed top-0 bottom-0 left-0 w-64 bg-white z-[61] transform -translate-x-full transition-transform duration-300 p-5 flex flex-col shadow-2xl">
        <div class="flex items-center gap-3 mb-8">
            <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white font-bold text-lg">U</div>
            <div>
                <p class="font-bold text-sm">User V19</p>
                <p class="text-xs text-gray-500">Nav Swapped & FAB Fixed</p>
            </div>
        </div>
        <button onclick="openResetModal()" class="w-full flex items-center gap-3 p-3 hover:bg-red-50 text-red-600 rounded-xl text-left mt-auto transition-colors text-sm font-medium tap-effect">
            <i class="ph ph-trash text-lg"></i> Reset Data
        </button>
    </div>

    <!-- MAIN VIEW AREA -->
    <main id="main-view" class="flex-1 bg-gray-50 relative overflow-hidden flex flex-col">
        <!-- Content injected by JS -->
    </main>

    <!-- FAB (Floating Action Button) - FIXED ANIMATION -->
    <!-- Wrapper handles positioning, Button handles animation -->
    <div class="absolute bottom-[20px] left-1/2 -translate-x-1/2 z-50">
        <button onclick="openIncomeModal()" class="bg-primary text-white w-14 h-14 rounded-full shadow-lg shadow-blue-500/30 flex items-center justify-center btn-press border-4 border-white hover:bg-blue-600 transition-colors">
            <i class="ph ph-plus text-2xl font-bold"></i>
        </button>
    </div>

    <!-- BOTTOM NAV - SWAPPED POSITIONS -->
    <footer class="h-[70px] flex-none bg-white border-t border-gray-100 z-40 flex justify-between items-center px-2 text-[10px] font-medium text-gray-400 pb-2">
        <button onclick="navigateTo('dashboard')" class="flex flex-col items-center gap-1 w-1/5 p-2 btn-press nav-btn text-primary" id="nav-dashboard">
            <i class="ph ph-house text-xl"></i> Home
        </button>
        <button onclick="navigateTo('banks')" class="flex flex-col items-center gap-1 w-1/5 p-2 btn-press nav-btn" id="nav-banks">
            <i class="ph ph-bank text-xl"></i> Bank
        </button>
        
        <!-- Spacer for FAB -->
        <div class="w-1/5 h-full pointer-events-none"></div>

        <!-- SWAPPED: Dompet dulu, baru Riwayat -->
        <button onclick="navigateTo('dompet')" class="flex flex-col items-center gap-1 w-1/5 p-2 btn-press nav-btn" id="nav-dompet">
            <i class="ph ph-wallet text-xl"></i> Dompet
        </button>
        <button onclick="navigateTo('riwayat')" class="flex flex-col items-center gap-1 w-1/5 p-2 btn-press nav-btn" id="nav-riwayat">
            <i class="ph ph-clock-counter-clockwise text-xl"></i> Riwayat
        </button>
    </footer>

    <!-- === MODALS === -->

    <!-- 1. INCOME -->
    <div id="modal-income" class="fixed inset-0 z-[70] modal-enter transition-modal flex items-end sm:items-center justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal('modal-income')"></div>
        <div class="modal-content bg-white w-full max-w-[480px] p-5 rounded-t-2xl sm:rounded-2xl relative z-10">
            <div class="w-10 h-1 bg-gray-300 rounded-full mx-auto mb-5"></div>
            <h2 class="text-lg font-bold mb-4 text-dark">Terima Income</h2>
            <form onsubmit="handleSubmitIncome(event)">
                <div class="space-y-3">
                    <input type="text" id="inc-name" placeholder="Sumber (Gaji/Bonus)" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all" required>
                    
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-gray-500 font-bold text-sm">Rp</span>
                        <input type="text" inputmode="numeric" id="inc-amount" onkeyup="formatCurrency(this)" placeholder="0" class="w-full pl-10 p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold text-lg outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all text-dark" required>
                    </div>
                    
                    <div class="relative">
                        <i class="ph ph-calendar-blank absolute left-3 top-3 text-gray-400 text-lg"></i>
                        <input type="datetime-local" id="inc-date" class="w-full pl-10 p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none text-sm text-gray-600">
                    </div>

                    <div class="relative">
                        <select id="inc-bank-target" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none appearance-none pr-8 text-sm text-dark" required></select>
                        <i class="ph ph-caret-down absolute right-3 top-3.5 text-gray-400"></i>
                    </div>
                </div>
                <button type="submit" class="w-full bg-primary text-white py-3.5 rounded-xl font-bold mt-5 btn-press shadow-lg shadow-blue-500/20 text-sm">Simpan Income</button>
            </form>
        </div>
    </div>

    <!-- 2. ALOKASI -->
    <div id="modal-alokasi" class="fixed inset-0 z-[70] modal-enter transition-modal flex items-end sm:items-center justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal('modal-alokasi')"></div>
        <div class="modal-content bg-white w-full max-w-[480px] p-5 rounded-t-2xl sm:rounded-2xl relative z-10">
            <div class="w-10 h-1 bg-gray-300 rounded-full mx-auto mb-5"></div>
            <h2 class="text-lg font-bold text-primary mb-1">Alokasi Dana</h2>
            <p class="text-xs text-gray-500 mb-4">Pindahkan dari Bank -> Dompet</p>
            <form onsubmit="handleSubmitAlokasi(event)">
                <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 mb-2">
                    <p class="text-[10px] font-bold text-blue-500 uppercase mb-1">Dari (Bank)</p>
                    <div class="relative">
                        <select id="alo-from-id" class="w-full bg-transparent font-bold text-sm outline-none appearance-none pr-6 text-dark" required></select>
                        <i class="ph ph-caret-down absolute right-0 top-0.5 text-blue-400"></i>
                    </div>
                </div>
                
                <div class="flex justify-center -my-3 relative z-10"><div class="bg-white rounded-full p-1.5 border shadow-sm text-gray-400"><i class="ph ph-arrow-down text-lg"></i></div></div>
                
                <div class="bg-green-50 p-3 rounded-xl border border-green-100 mt-2 mb-3">
                    <p class="text-[10px] font-bold text-green-600 uppercase mb-1">Ke (Dompet)</p>
                    <div class="relative">
                        <select id="alo-to-id" class="w-full bg-transparent font-bold text-sm outline-none appearance-none pr-6 text-dark" required></select>
                        <i class="ph ph-caret-down absolute right-0 top-0.5 text-green-500"></i>
                    </div>
                </div>

                <div class="relative mb-3">
                    <i class="ph ph-calendar-blank absolute left-3 top-3 text-gray-400"></i>
                    <input type="datetime-local" id="alo-date" class="w-full pl-9 p-2.5 bg-gray-50 border border-gray-200 rounded-xl outline-none text-xs text-gray-600">
                </div>

                <div class="relative">
                    <span class="absolute left-3 top-3 text-gray-400 font-bold text-sm">Rp</span>
                    <input type="text" inputmode="numeric" id="alo-amount" onkeyup="formatCurrency(this)" placeholder="0" class="w-full pl-10 p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold text-lg outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all text-dark" required>
                </div>
                
                <button type="submit" class="w-full bg-dark text-white py-3.5 rounded-xl font-bold mt-5 btn-press shadow-lg text-sm">Pindahkan</button>
            </form>
        </div>
    </div>

    <!-- 3. EXPENSE -->
    <div id="modal-expense" class="fixed inset-0 z-[70] modal-enter transition-modal flex items-end sm:items-center justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal('modal-expense')"></div>
        <div class="modal-content bg-white w-full max-w-[480px] p-5 rounded-t-2xl sm:rounded-2xl relative z-10">
            <div class="w-10 h-1 bg-gray-300 rounded-full mx-auto mb-5"></div>
            <h2 class="text-lg font-bold text-red-600 mb-1">Catat Pengeluaran</h2>
            <p class="text-xs text-gray-500 mb-4">Gunakan saldo dari Dompet</p>
            <form onsubmit="handleSubmitExpense(event)">
                <div class="bg-red-50 p-3 rounded-xl border border-red-100 mb-3">
                    <p class="text-[10px] font-bold text-red-500 uppercase mb-1">Sumber Dana</p>
                    <p id="exp-from-name" class="font-bold text-sm text-dark">Dompet</p>
                    <input type="hidden" id="exp-from-id">
                    <p id="exp-from-bal" class="text-xs text-red-400 font-mono mt-0.5">Rp 0</p>
                </div>
                
                <div class="space-y-3">
                    <input type="text" id="exp-title" placeholder="Untuk beli apa?" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-all" required>
                    
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-gray-400 font-bold text-sm">Rp</span>
                        <input type="text" inputmode="numeric" id="exp-amount" onkeyup="formatCurrency(this)" placeholder="0" class="w-full pl-10 p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold text-lg outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-all text-dark" required>
                    </div>

                    <div class="relative">
                        <i class="ph ph-calendar-blank absolute left-3 top-3 text-gray-400 text-lg"></i>
                        <input type="datetime-local" id="exp-date" class="w-full pl-10 p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none text-sm text-gray-600">
                    </div>
                </div>
                <button type="submit" class="w-full bg-red-600 text-white py-3.5 rounded-xl font-bold mt-5 btn-press shadow-lg shadow-red-500/20 text-sm">Bayar Sekarang</button>
            </form>
        </div>
    </div>

    <!-- 4. EDIT TRANSACTION -->
    <div id="modal-edit-tx" class="fixed inset-0 z-[80] modal-enter transition-modal flex items-end sm:items-center justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal('modal-edit-tx')"></div>
        <div class="modal-content bg-white w-full max-w-[480px] p-5 rounded-t-2xl sm:rounded-2xl relative z-10">
            <h2 class="text-lg font-bold mb-4">Edit Transaksi</h2>
            <form onsubmit="handleEditTransaction(event)">
                <input type="hidden" id="edit-id">
                <div class="space-y-3">
                    <div>
                        <label class="text-[10px] text-gray-500 font-bold uppercase">Judul</label>
                        <input type="text" id="edit-title" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl mt-1 text-sm outline-none focus:border-primary">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-500 font-bold uppercase">Jumlah (Update Saldo)</label>
                        <div class="relative mt-1">
                            <span class="absolute left-3 top-3 text-gray-400 font-bold text-sm">Rp</span>
                            <input type="text" inputmode="numeric" id="edit-amount" onkeyup="formatCurrency(this)" class="w-full pl-10 p-3 bg-gray-50 border border-gray-200 rounded-xl font-bold text-lg outline-none focus:border-primary">
                        </div>
                    </div>
                </div>
                <button type="submit" class="w-full bg-primary text-white py-3.5 rounded-xl font-bold mt-5 btn-press text-sm">Simpan Perubahan</button>
            </form>
        </div>
    </div>

    <!-- 5. ADD ENTITY -->
    <div id="modal-add-entity" class="fixed inset-0 z-[70] modal-enter transition-modal flex items-end sm:items-center justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal('modal-add-entity')"></div>
        <div class="modal-content bg-white w-full max-w-[480px] p-5 rounded-t-2xl sm:rounded-2xl relative z-10">
            <h2 class="text-lg font-bold mb-4" id="modal-entity-title">Tambah Baru</h2>
            <form onsubmit="handleAddEntity(event)">
                <input type="hidden" id="entity-type">
                <div class="space-y-3">
                    <input type="text" id="entity-name" placeholder="Nama (cth: Bank Jago / Dompet Saku)" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none focus:border-primary" required>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-gray-400 font-bold text-sm">Rp</span>
                        <input type="text" inputmode="numeric" id="entity-balance" onkeyup="formatCurrency(this)" placeholder="Saldo Awal" class="w-full pl-10 p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none text-sm">
                    </div>
                </div>
                <button type="submit" class="w-full bg-primary text-white py-3.5 rounded-xl font-bold mt-5 btn-press text-sm">Buat Sekarang</button>
            </form>
        </div>
    </div>

    <!-- 6. FILTER & DOWNLOAD -->
    <div id="modal-filter" class="fixed inset-0 z-[80] modal-enter transition-modal flex items-end sm:items-center justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal('modal-filter')"></div>
        <div class="modal-content bg-white w-full max-w-[480px] p-5 rounded-t-2xl sm:rounded-2xl relative z-10">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><i class="ph ph-funnel"></i> Filter & Unduh</h2>
            <div class="space-y-3">
                <select id="filter-type" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none text-sm text-dark"><option value="all">Semua Tipe Transaksi</option><option value="income">Pemasukan</option><option value="expense">Pengeluaran</option><option value="transfer">Alokasi/Transfer</option></select>
                <select id="filter-time" onchange="toggleCustomDate()" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none text-sm text-dark"><option value="all">Semua Waktu</option><option value="this_month">Bulan Ini</option><option value="last_month">Bulan Lalu</option><option value="custom">Pilih Tanggal Sendiri...</option></select>
                <div id="custom-date-area" class="hidden flex gap-2">
                    <input type="date" id="filter-start" class="w-1/2 p-2 border border-gray-200 rounded-lg text-xs text-gray-600">
                    <input type="date" id="filter-end" class="w-1/2 p-2 border border-gray-200 rounded-lg text-xs text-gray-600">
                </div>
                <button onclick="applyFilter()" class="w-full bg-dark text-white py-3.5 rounded-xl font-bold mt-2 btn-press text-sm">Terapkan Filter</button>
            </div>
        </div>
    </div>

    <div id="modal-download-opt" class="fixed inset-0 z-[80] modal-enter transition-modal flex items-end sm:items-center justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal('modal-download-opt')"></div>
        <div class="modal-content bg-white w-full max-w-[480px] p-5 rounded-t-2xl sm:rounded-2xl relative z-10">
            <h2 class="text-lg font-bold mb-4">Download Laporan</h2>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="downloadCSV()" class="p-4 bg-green-50 border border-green-100 rounded-xl flex flex-col items-center gap-2 btn-press hover:bg-green-100 transition-colors"><i class="ph ph-file-csv text-3xl text-green-600"></i><span class="text-xs font-bold text-green-700">Excel / CSV</span></button>
                <button onclick="downloadImage()" class="p-4 bg-blue-50 border border-blue-100 rounded-xl flex flex-col items-center gap-2 btn-press hover:bg-blue-100 transition-colors"><i class="ph ph-image text-3xl text-blue-600"></i><span class="text-xs font-bold text-blue-700">Gambar Struk</span></button>
            </div>
            <button onclick="closeModal('modal-download-opt')" class="w-full mt-4 py-2 text-gray-400 text-xs font-bold">Batal</button>
        </div>
    </div>
    
    <!-- 7. RESET DATA MODAL -->
    <div id="modal-reset" class="fixed inset-0 z-[80] modal-enter transition-modal flex items-end sm:items-center justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal('modal-reset')"></div>
        <div class="modal-content bg-white w-full max-w-[480px] p-5 rounded-t-2xl sm:rounded-2xl relative z-10">
            <h2 class="text-lg font-bold mb-2 text-red-600">Reset Data</h2>
            <p class="text-xs text-gray-500 mb-4">Pilih jenis reset yang ingin dilakukan. Tindakan ini tidak dapat dibatalkan.</p>
            
            <div class="space-y-3 mb-6">
                <!-- Option 1: Hapus Nominal -->
                <label class="flex items-start gap-3 p-3 border border-gray-200 rounded-xl cursor-pointer transition-colors relative hover:bg-gray-50">
                    <input type="radio" name="resetOption" value="nominal" class="radio-box absolute opacity-0 w-0 h-0" checked>
                    <div class="w-5 h-5 rounded-full border-2 border-gray-300 flex items-center justify-center flex-shrink-0 mt-0.5 transition-colors">
                        <div class="w-2.5 h-2.5 rounded-full bg-transparent radio-indicator"></div>
                    </div>
                    <div>
                        <p class="font-bold text-sm text-dark">Hapus Nominal & Riwayat</p>
                        <p class="text-xs text-gray-500 mt-1">Saldo akan jadi 0. Riwayat dihapus. Tapi nama Bank & Dompet TETAP ADA.</p>
                    </div>
                </label>

                <!-- Option 2: Hapus Total -->
                <label class="flex items-start gap-3 p-3 border border-gray-200 rounded-xl cursor-pointer transition-colors relative hover:bg-red-50 border-red-100">
                    <input type="radio" name="resetOption" value="total" class="radio-box absolute opacity-0 w-0 h-0">
                    <div class="w-5 h-5 rounded-full border-2 border-gray-300 flex items-center justify-center flex-shrink-0 mt-0.5 transition-colors">
                        <div class="w-2.5 h-2.5 rounded-full bg-transparent radio-indicator"></div>
                    </div>
                    <div>
                        <p class="font-bold text-sm text-red-600">Hapus Total (Factory Reset)</p>
                        <p class="text-xs text-red-400 mt-1">Semua data Bank, Dompet, dan Riwayat akan DIHAPUS PERMANEN. Aplikasi jadi kosong.</p>
                    </div>
                </label>
            </div>

            <button onclick="confirmReset()" class="w-full bg-red-600 text-white py-3.5 rounded-xl font-bold btn-press text-sm shadow-lg shadow-red-500/30">Proses Reset</button>
            <button onclick="closeModal('modal-reset')" class="w-full mt-3 py-2 text-gray-400 text-xs font-bold">Batal</button>
        </div>
    </div>

    <!-- 8. DETAIL TRANSACTION MODAL -->
    <div id="modal-detail-tx" class="fixed inset-0 z-[80] modal-enter transition-modal flex items-end sm:items-center justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeModal('modal-detail-tx')"></div>
        <div class="modal-content bg-white w-full max-w-[480px] p-5 rounded-t-2xl sm:rounded-2xl relative z-10">
            <div class="w-10 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <h2 class="text-base font-bold mb-5 text-center text-gray-700">Detail Transaksi</h2>
            <div id="detail-tx-content" class="space-y-4">
                <!-- Content injected here -->
            </div>
             <button onclick="closeModal('modal-detail-tx')" class="w-full mt-6 py-3 text-gray-400 text-xs font-bold btn-press">Tutup</button>
        </div>
    </div>

    <!-- HIDDEN RENDER AREA -->
    <div id="report-render-area" class="fixed top-0 left-[-1500px] w-[500px] bg-white text-dark z-[-1] p-8 font-sans">
        <div class="flex items-center justify-between mb-6 border-b border-gray-200 pb-4">
            <div>
                <h1 class="text-2xl font-bold text-primary tracking-tight">Laporan Keuangan</h1>
                <p class="text-xs text-gray-500 mt-1">Dicetak: <span id="rep-print-date"></span></p>
            </div>
            <i class="ph ph-bank text-4xl text-gray-300"></i>
        </div>
        <div class="mb-6">
            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">Periode</p>
            <p id="rep-period" class="text-lg font-bold text-dark">Semua Waktu</p>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-8 p-4 bg-gray-50 rounded-xl border border-gray-100">
            <div><p class="text-[10px] uppercase font-bold text-gray-500 mb-1">Total Pemasukan</p><p id="rep-in" class="text-xl font-bold text-green-600">0</p></div>
            <div class="text-right"><p class="text-[10px] uppercase font-bold text-gray-500 mb-1">Total Pengeluaran</p><p id="rep-out" class="text-xl font-bold text-red-600">0</p></div>
        </div>
        <p class="text-[10px] font-bold text-gray-400 uppercase mb-3 pb-1 border-b border-gray-200">Rincian Transaksi</p>
        <div id="rep-list" class="space-y-3 text-sm"></div>
        <div class="mt-8 pt-4 border-t border-gray-100 text-center text-[10px] text-gray-400">Dibuat otomatis oleh Sistem Keuangan V19</div>
    </div>

    <!-- AI MODAL -->
    <div id="modal-ai" class="fixed inset-0 z-[80] modal-enter transition-modal flex items-end sm:items-center justify-center">
        <div class="absolute inset-0 bg-magic/10 backdrop-blur-sm" onclick="closeModal('modal-ai')"></div>
        <div class="modal-content bg-white w-full max-w-[480px] p-5 rounded-t-3xl sm:rounded-3xl relative z-10 border-t-4 border-magic m-0 sm:m-4"><div id="ai-content" class="min-h-[200px]"></div></div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-10 left-1/2 -translate-x-1/2 bg-dark text-white px-5 py-2.5 rounded-full shadow-xl z-[90] text-xs font-medium transition-all duration-300 opacity-0 translate-y-[-20px] pointer-events-none flex items-center gap-2"><i class="ph ph-check-circle text-accent text-lg"></i><span id="toast-msg">Berhasil</span></div>

</div>

<!-- LOGIC -->
<script>
    // --- 1. STATE & DATA GENERATOR ---
    function generateDummyData() {
        const titles = {
            income: ['Gaji Bulanan', 'Bonus Project', 'Dividen', 'Cashback', 'Jual Barang', 'Hadiah'],
            expense: ['Makan Siang', 'Bensin', 'Listrik', 'Pulsa', 'Ngopi', 'Belanja', 'Parkir', 'Obat', 'Laundry'],
            transfer: ['Topup OVO', 'Tarik Tunai', 'Tabung Jago', 'Isi Dompet']
        };
        const txs = [];
        const banks = ['b1', 'b2'];
        const dompets = ['d1', 'd2'];
        
        for (let i = 0; i < 50; i++) {
            const type = ['income', 'expense', 'transfer'][Math.floor(Math.random() * 3)];
            const date = new Date();
            date.setDate(date.getDate() - Math.floor(Math.random() * 60));
            
            let tx = {
                id: Date.now() + i,
                date: date.toISOString(),
                amount: (Math.floor(Math.random() * 20) + 1) * 10000,
                type: type,
                title: titles[type][Math.floor(Math.random() * titles[type].length)]
            };

            if (type === 'income') { tx.dstId = banks[Math.floor(Math.random() * banks.length)]; tx.srcId = null; } 
            else if (type === 'expense') { tx.srcId = dompets[Math.floor(Math.random() * dompets.length)]; tx.dstId = null; } 
            else { tx.srcId = banks[0]; tx.dstId = dompets[0]; }
            txs.push(tx);
        }
        return txs.sort((a,b) => new Date(b.date) - new Date(a.date));
    }

    const defaultData = {
        banks: [ { id: 'b1', name: 'Gaji BCA', balance: 5000000 }, { id: 'b2', name: 'Jago', balance: 1250000 } ],
        dompets: [ { id: 'd1', name: 'Cash', balance: 500000, notes: '' }, { id: 'd2', name: 'GoPay', balance: 250000, notes: '' } ],
        transactions: []
    };

    let appData = JSON.parse(localStorage.getItem('financeV19'));
    
    // Auto Generate if null (First Load Only)
    if (!appData) {
        appData = JSON.parse(JSON.stringify(defaultData));
        appData.transactions = generateDummyData();
        localStorage.setItem('financeV19', JSON.stringify(appData));
    }

    let activeTransactions = [...appData.transactions];
    let currentView = 'dashboard';
    let currentParam = null;
    const apiKey = ""; 

    // --- 2. HELPERS ---
    const formatIDR = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(n);
    const formatDate = (d) => new Date(d).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', hour:'2-digit', minute:'2-digit' });
    
    function formatCurrency(input) {
        let value = input.value.replace(/[^0-9]/g, '');
        if (value) { value = parseInt(value, 10).toLocaleString('id-ID'); input.value = value; } else { input.value = ''; }
    }
    function cleanCurrency(val) { return parseInt(val.replace(/\./g, '')) || 0; }

    const showToast = (msg) => {
        const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg;
        t.classList.remove('opacity-0', 'translate-y-[-20px]'); setTimeout(() => t.classList.add('opacity-0', 'translate-y-[-20px]'), 2000);
    };

    function saveData() { 
        localStorage.setItem('financeV19', JSON.stringify(appData));
        if(currentView !== 'riwayat') activeTransactions = [...appData.transactions];
        render(currentParam); 
    }
    
    // --- RESET LOGIC UPDATED ---
    function openResetModal() { toggleDrawer(false); openModal('modal-reset'); }
    
    function confirmReset() {
        const option = document.querySelector('input[name="resetOption"]:checked').value;
        
        if(option === 'nominal') {
            // Reset balances to 0, clear transactions, KEEP names
            appData.banks.forEach(b => b.balance = 0);
            appData.dompets.forEach(d => { d.balance = 0; d.notes = ''; });
            appData.transactions = [];
            activeTransactions = [];
            
            saveData();
            showToast("Nominal & Riwayat Direset!");
        } else if (option === 'total') {
            // Factory Reset (Clear All)
            appData = { banks: [], dompets: [], transactions: [] };
            activeTransactions = [];
            // Prevent auto-generate on next reload by saving this empty state
            localStorage.setItem('financeV19', JSON.stringify(appData));
            
            saveData();
            showToast("Semua Data Dihapus!");
        }
        
        closeModal('modal-reset');
        navigateTo('dashboard');
    }

    // --- 3. LOGIC ---
    function processTransaction(title, amount, type, srcId, dstId, idOverride=null, dateOverride=null) {
        const val = amount;
        if(!val || val <= 0) { alert("Jumlah harus > 0"); return false; }
        
        if(type === 'income') {
            const b = appData.banks.find(x => x.id === dstId); if(b) b.balance += val;
        } else if (type === 'transfer') {
            const src = appData.banks.find(x => x.id === srcId) || appData.dompets.find(x => x.id === srcId);
            const dst = appData.dompets.find(x => x.id === dstId);
            if(src && dst) { src.balance -= val; dst.balance += val; }
        } else if (type === 'expense') {
            const d = appData.dompets.find(x => x.id === srcId); if(d) d.balance -= val;
        }

        const newTx = {
            id: idOverride || Date.now(),
            date: dateOverride || new Date().toISOString(),
            title, amount: val, type, srcId, dstId
        };
        
        if(!idOverride) appData.transactions.unshift(newTx);
        saveData();
        return true;
    }

    function reverseTransaction(tx) {
        if(tx.type === 'income') {
            const b = appData.banks.find(x => x.id === tx.dstId); if(b) b.balance -= tx.amount;
        } else if (tx.type === 'transfer') {
            const src = appData.banks.find(x => x.id === tx.srcId) || appData.dompets.find(x => x.id === tx.srcId);
            const dst = appData.dompets.find(x => x.id === tx.dstId);
            if(src && dst) { src.balance += tx.amount; dst.balance -= tx.amount; }
        } else if (tx.type === 'expense') {
            const d = appData.dompets.find(x => x.id === tx.srcId); if(d) d.balance += tx.amount;
        }
    }

    function deleteTransaction(id) {
        if(!confirm("Hapus? Saldo akan dikembalikan.")) return;
        const idx = appData.transactions.findIndex(t => t.id == id);
        if(idx === -1) return;
        reverseTransaction(appData.transactions[idx]); 
        appData.transactions.splice(idx, 1);
        saveData();
        showToast("Dihapus");
        if(document.getElementById('modal-detail-tx')) closeModal('modal-detail-tx');
        render(currentParam); 
    }

    function openEditTransaction(id) {
        if(document.getElementById('modal-detail-tx')) closeModal('modal-detail-tx');
        const tx = appData.transactions.find(t => t.id == id);
        if(!tx) return;
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-title').value = tx.title;
        document.getElementById('edit-amount').value = tx.amount.toLocaleString('id-ID');
        openModal('modal-edit-tx');
    }

    function handleEditTransaction(e) {
        e.preventDefault();
        const id = document.getElementById('edit-id').value;
        const newTitle = document.getElementById('edit-title').value;
        const newAmount = cleanCurrency(document.getElementById('edit-amount').value);
        
        const idx = appData.transactions.findIndex(t => t.id == id);
        const oldTx = appData.transactions[idx];
        reverseTransaction(oldTx);
        
        if(oldTx.type === 'income') {
             const b = appData.banks.find(x => x.id === oldTx.dstId); if(b) b.balance += newAmount;
        } else if (oldTx.type === 'transfer') {
             const src = appData.banks.find(x => x.id === oldTx.srcId) || appData.dompets.find(x => x.id === oldTx.srcId);
             const dst = appData.dompets.find(x => x.id === oldTx.dstId);
             if(src && dst) { src.balance -= newAmount; dst.balance += newAmount; }
        } else if (oldTx.type === 'expense') {
             const d = appData.dompets.find(x => x.id === oldTx.srcId); if(d) d.balance -= newAmount;
        }

        oldTx.title = newTitle;
        oldTx.amount = newAmount;
        closeModal('modal-edit-tx');
        saveData();
        showToast("Diupdate");
    }

    function createEntity(type, name, bal) {
        const id = (type==='bank'?'b':'d') + Date.now();
        const ibal = cleanCurrency(bal);
        const item = {id, name, balance: ibal, notes: ''};
        if(type==='bank') appData.banks.push(item); else appData.dompets.push(item);
        if(ibal>0) processTransaction(`Saldo Awal ${name}`, ibal, 'income', null, id);
        saveData();
    }
    
    function updateDompetNote(id, note) {
        const d = appData.dompets.find(x => x.id === id);
        if(d) { d.notes = note; localStorage.setItem('financeV19', JSON.stringify(appData)); }
    }

    // --- 4. RENDER ---
    function navigateTo(view, param = null) {
        currentView = view;
        currentParam = param;
        if(view !== 'riwayat') activeTransactions = [...appData.transactions];

        document.querySelectorAll('.nav-btn').forEach(b => { 
            b.classList.remove('text-primary'); 
            b.classList.add('text-gray-400'); 
        });
        
        const navId = 'nav-' + (view.includes('bank') ? 'banks' : view.includes('dompet') ? 'dompet' : view);
        const navEl = document.getElementById(navId);
        if(navEl) {
            navEl.classList.replace('text-gray-400', 'text-primary');
        }

        render(param);
        window.scrollTo(0,0);
    }

    function getSummary() {
        const today = new Date().toDateString();
        const thisMonth = new Date().getMonth();
        const thisYear = new Date().getFullYear();
        let dIn = 0, dOut = 0, mIn = 0, mOut = 0;
        appData.transactions.forEach(t => {
            const tDate = new Date(t.date);
            if(tDate.toDateString() === today) { if(t.type === 'income') dIn += t.amount; if(t.type === 'expense') dOut += t.amount; }
            if(tDate.getMonth() === thisMonth && tDate.getFullYear() === thisYear) { if(t.type === 'income') mIn += t.amount; if(t.type === 'expense') mOut += t.amount; }
        });
        return { dIn, dOut, mIn, mOut };
    }

    function render(param) {
        const main = document.getElementById('main-view');
        const title = document.getElementById('header-title');
        main.innerHTML = '';
        
        // Dynamic Layout Class based on view
        if(currentView === 'riwayat' || currentView === 'dompet-detail' || currentView === 'dashboard') {
             main.className = "flex-1 bg-gray-50 relative overflow-hidden flex flex-col";
        } else {
             main.className = "flex-1 bg-gray-50 overflow-y-auto pb-28";
        }

        const totBank = appData.banks.reduce((a,b)=>a+b.balance,0);
        const totDompet = appData.dompets.reduce((a,b)=>a+b.balance,0);

        if(currentView === 'dashboard') {
            title.innerText = 'Dashboard';
            const sum = getSummary();
            
            const topSection = document.createElement('div');
            topSection.className = "layout-fixed p-4 pb-2 bg-gray-50 z-10";
            topSection.innerHTML = `
                 <div class="bg-gradient-to-br from-blue-600 to-blue-500 rounded-2xl p-5 text-white shadow-lg mb-4 relative overflow-hidden">
                    <i class="ph ph-coins absolute -right-3 -bottom-3 text-7xl text-white/10"></i>
                    <div class="relative z-10">
                        <p class="text-blue-100 text-[10px] font-bold uppercase tracking-wider mb-1">Total Harta</p>
                        <h2 class="text-2xl font-bold mb-3">${formatIDR(totBank + totDompet)}</h2>
                        <div class="flex gap-2">
                            <div class="bg-white/20 backdrop-blur-sm px-2.5 py-1 rounded text-[10px] flex items-center gap-1.5"><i class="ph ph-bank"></i> ${formatIDR(totBank)}</div>
                            <div class="bg-white/20 backdrop-blur-sm px-2.5 py-1 rounded text-[10px] flex items-center gap-1.5"><i class="ph ph-wallet"></i> ${formatIDR(totDompet)}</div>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div class="bg-white p-3.5 rounded-xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] text-gray-400 uppercase font-bold">Hari Ini</p>
                        <div class="flex justify-between items-end mt-1">
                            <span class="text-green-600 text-xs font-bold">${formatIDR(sum.dIn)}</span>
                            <span class="text-red-600 text-xs font-bold">${formatIDR(sum.dOut)}</span>
                        </div>
                    </div>
                    <div class="bg-white p-3.5 rounded-xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] text-gray-400 uppercase font-bold">Bulan Ini</p>
                        <div class="flex justify-between items-end mt-1">
                            <span class="text-green-600 text-xs font-bold">${formatIDR(sum.mIn)}</span>
                            <span class="text-red-600 text-xs font-bold">${formatIDR(sum.mOut)}</span>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between items-center px-1 py-1">
                    <h3 class="font-bold text-dark text-sm">Aktivitas Terkini</h3>
                    <button onclick="navigateTo('riwayat')" class="text-primary text-xs font-bold">Lihat Semua</button>
                </div>
            `;
            const scrollSection = document.createElement('div');
            scrollSection.className = "layout-scroll px-4 pb-20 space-y-3";
            scrollSection.innerHTML = renderTxList(appData.transactions.slice(0, 10), true);
            main.appendChild(topSection);
            main.appendChild(scrollSection);
        }
        else if (currentView === 'banks') {
            title.innerText = 'Daftar Bank';
            main.innerHTML = `
                <div class="p-4">
                    <div class="space-y-3">
                        ${appData.banks.map(b => `
                            <div onclick="navigateTo('bank-detail', '${b.id}')" class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between tap-effect">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-primary"><i class="ph ph-bank text-lg"></i></div>
                                    <div><h4 class="font-bold text-dark text-sm">${b.name}</h4><p class="text-xs text-gray-500">${formatIDR(b.balance)}</p></div>
                                </div><i class="ph ph-caret-right text-gray-300"></i>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="openAddModal('bank')" class="mt-5 w-full py-3.5 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold flex items-center justify-center gap-2 hover:border-primary text-xs"><i class="ph ph-plus-circle text-base"></i> Tambah Bank</button>
                </div>
            `;
        }
        else if (currentView === 'bank-detail') {
            const b = appData.banks.find(x => x.id === param);
            if(!b) return navigateTo('banks');
            title.innerText = 'Detail Bank';
            const txs = appData.transactions.filter(t => t.srcId === b.id || t.dstId === b.id);
            main.innerHTML = `
                <div class="p-4">
                    <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm text-center mb-6">
                        <h2 class="font-bold text-gray-800 text-sm">${b.name}</h2>
                        <h1 class="text-3xl font-bold text-dark mb-6 mt-1">${formatIDR(b.balance)}</h1>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="openIncomeModal('${b.id}')" class="bg-green-50 text-green-700 py-3 rounded-xl text-xs font-bold flex flex-col items-center justify-center gap-1 btn-press"><i class="ph ph-plus text-lg"></i> Isi Saldo</button>
                            <button onclick="openAlokasiModal('${b.id}')" class="bg-blue-50 text-blue-700 py-3 rounded-xl text-xs font-bold flex flex-col items-center justify-center gap-1 btn-press"><i class="ph ph-arrows-left-right text-lg"></i> Alokasi</button>
                        </div>
                    </div>
                    <h3 class="font-bold mb-3 px-1 text-sm text-gray-700">Riwayat Transaksi</h3>
                    <div class="space-y-2">${renderTxList(txs, true)}</div>
                </div>
            `;
        }
        else if (currentView === 'dompet') {
            title.innerText = 'Daftar Dompet';
            main.innerHTML = `
                <div class="p-4">
                    <div class="grid gap-3">
                        ${appData.dompets.map(d => `
                            <div onclick="navigateTo('dompet-detail', '${d.id}')" class="bg-white p-4 rounded-xl border-l-4 border-accent shadow-sm flex items-center justify-between tap-effect">
                                <div><h4 class="font-bold text-dark text-sm">${d.name}</h4><p class="text-xs text-gray-500">${formatIDR(d.balance)}</p></div><i class="ph ph-caret-right text-gray-300"></i>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="openAddModal('dompet')" class="mt-5 w-full py-3.5 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold flex items-center justify-center gap-2 hover:border-primary text-xs"><i class="ph ph-plus-circle text-base"></i> Tambah Dompet</button>
                </div>
            `;
        }
        else if (currentView === 'dompet-detail') {
            const d = appData.dompets.find(x => x.id === param);
            if(!d) return navigateTo('dompet');
            title.innerText = 'Detail Dompet';
            const txs = appData.transactions.filter(t => t.dstId === d.id || t.srcId === d.id);
            
            const topSection = document.createElement('div');
            topSection.className = "layout-fixed p-4 pb-0 bg-gray-50 z-10";
            topSection.innerHTML = `
                <div class="bg-white rounded-2xl p-6 border border-gray-100 shadow-sm text-center mb-4">
                    <h2 class="font-bold text-gray-800 text-sm">${d.name}</h2>
                    <h1 class="text-3xl font-bold text-dark mb-6 mt-1">${formatIDR(d.balance)}</h1>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="openTopUpDompet('${d.id}')" class="bg-green-50 text-green-700 py-3 rounded-xl text-[10px] font-bold flex flex-col items-center gap-1 btn-press"><i class="ph ph-download-simple text-lg"></i> Isi</button>
                        <button onclick="openPindahDompet('${d.id}')" class="bg-blue-50 text-blue-700 py-3 rounded-xl text-[10px] font-bold flex flex-col items-center gap-1 btn-press"><i class="ph ph-arrows-left-right text-lg"></i> Pindah</button>
                        <button onclick="openExpenseModal('${d.id}')" class="bg-red-50 text-red-700 py-3 rounded-xl text-[10px] font-bold flex flex-col items-center gap-1 btn-press"><i class="ph ph-hand-coins text-lg"></i> Bayar</button>
                    </div>
                </div>
                
                <div class="bg-yellow-50 p-3 rounded-xl border border-yellow-100 mb-4 shadow-sm">
                    <label class="flex items-center gap-1 text-[10px] font-bold text-yellow-600 uppercase mb-1">
                        <i class="ph ph-note-pencil text-sm"></i> Catatan
                    </label>
                    <textarea onchange="updateDompetNote('${d.id}', this.value)" class="w-full bg-transparent text-xs text-gray-700 outline-none resize-none placeholder-yellow-300 leading-relaxed" rows="2" placeholder="Tulis rencana penggunaan...">${d.notes || ''}</textarea>
                </div>

                <h3 class="font-bold mb-3 px-1 text-sm text-gray-700">Riwayat</h3>
            `;

            const scrollSection = document.createElement('div');
            scrollSection.className = "layout-scroll px-4 pb-28 space-y-2";
            scrollSection.innerHTML = renderTxList(txs, true); 

            main.appendChild(topSection);
            main.appendChild(scrollSection);
        }
        else if (currentView === 'riwayat') {
            title.innerText = 'Riwayat';
            
            // FIXED HEADER for RIWAYAT
            const topSection = document.createElement('div');
            topSection.className = "layout-fixed p-4 pb-3 bg-gray-50 z-20 shadow-sm border-b border-gray-100";
            topSection.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="font-bold text-base text-dark">Data Transaksi</h2>
                        <p class="text-[10px] text-gray-400 mt-0.5">${activeTransactions.length} Data</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openFilter()" class="bg-white border border-gray-200 p-2.5 rounded-xl text-dark shadow-sm btn-press text-gray-600">
                            <i class="ph ph-funnel text-lg"></i>
                        </button>
                        <button onclick="openDownloadModal()" class="bg-white border border-gray-200 p-2.5 rounded-xl text-dark shadow-sm btn-press text-gray-600">
                            <i class="ph ph-download-simple text-lg"></i>
                        </button>
                    </div>
                </div>
            `;

            // SCROLLABLE LIST
            const scrollSection = document.createElement('div');
            scrollSection.className = "layout-scroll px-4 pb-28 pt-4 space-y-2";
            scrollSection.innerHTML = `<div id="riwayat-list" class="space-y-2">${renderTxList(activeTransactions, true)}</div>`;

            main.appendChild(topSection);
            main.appendChild(scrollSection);
        }
    }

    function renderTxList(list, allowActions = false) {
        if(!list || list.length === 0) return '<div class="text-center py-10 text-gray-400 text-xs">Belum ada transaksi.</div>';
        return list.map(t => {
            let icon = 'ph-arrow-down-left';
            let color = 'bg-green-100 text-green-600';
            let sign = '+';
            if(t.type === 'transfer') { icon = 'ph-arrows-left-right'; color = 'bg-blue-100 text-blue-600'; sign = ''; }
            if(t.type === 'expense') { icon = 'ph-arrow-up-right'; color = 'bg-red-100 text-red-600'; sign = '-'; }
            
            const displayDate = new Date(t.date).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', hour:'2-digit', minute:'2-digit' });
            const clickAction = allowActions ? `onclick="openDetailTransaction(${t.id})"` : '';

            return `
                <div ${clickAction} class="bg-white p-3.5 rounded-xl border border-gray-100 flex items-center justify-between shadow-sm tap-effect relative z-10">
                    <div class="flex items-center gap-3.5 flex-1 min-w-0">
                        <div class="w-10 h-10 rounded-full ${color} flex-shrink-0 flex items-center justify-center text-lg"><i class="ph ${icon}"></i></div>
                        <div class="min-w-0">
                            <h4 class="font-bold text-dark text-sm truncate">${t.title}</h4>
                            <p class="text-[10px] text-gray-400 mt-0.5">${displayDate}</p>
                        </div>
                    </div>
                    <span class="font-bold text-xs ${t.type==='income'?'text-green-600':(t.type==='expense'?'text-red-600':'text-dark')} whitespace-nowrap ml-2">${sign}${formatIDR(t.amount)}</span>
                </div>
            `;
        }).join('');
    }

    // --- 5. DETAIL ---
    function openDetailTransaction(id) {
        const tx = appData.transactions.find(t => t.id == id);
        if(!tx) return;
        
        let typeLabel = 'Pemasukan';
        if(tx.type === 'expense') typeLabel = 'Pengeluaran';
        if(tx.type === 'transfer') typeLabel = 'Alokasi/Pindah Dana';

        let sourceName = '-'; let destName = '-';
        if(tx.srcId) { const src = appData.banks.find(x=>x.id===tx.srcId)||appData.dompets.find(x=>x.id===tx.srcId); if(src) sourceName=src.name; }
        if(tx.dstId) { const dst = appData.banks.find(x=>x.id===tx.dstId)||appData.dompets.find(x=>x.id===tx.dstId); if(dst) destName=dst.name; }

        const detailHtml = `
            <div class="bg-gray-50 p-5 rounded-2xl mb-5 text-center relative border border-gray-100">
                <p class="text-[10px] text-gray-500 uppercase font-bold mb-1 tracking-wide">Nominal</p>
                <h3 class="text-2xl font-bold text-dark">${formatIDR(tx.amount)}</h3>
                <div class="flex justify-center gap-3 mt-5">
                    <button onclick="openEditTransaction(${tx.id})" class="px-4 py-2 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold flex items-center gap-1.5 border border-blue-100"><i class="ph ph-pencil-simple"></i> Edit</button>
                    <button onclick="deleteTransaction(${tx.id})" class="px-4 py-2 bg-red-50 text-red-600 rounded-lg text-xs font-bold flex items-center gap-1.5 border border-red-100"><i class="ph ph-trash"></i> Hapus</button>
                </div>
            </div>
             <div class="space-y-3 text-xs px-1">
                 <div class="flex justify-between border-b border-dashed border-gray-200 pb-2"> <span class="text-gray-500">Judul</span> <span class="font-bold text-dark text-right truncate ml-4">${tx.title}</span> </div>
                 <div class="flex justify-between border-b border-dashed border-gray-200 pb-2"> <span class="text-gray-500">Tipe</span> <span class="font-bold text-dark">${typeLabel}</span> </div>
                 <div class="flex justify-between border-b border-dashed border-gray-200 pb-2"> <span class="text-gray-500">Waktu</span> <span class="font-bold text-dark text-right">${formatDate(tx.date)}</span> </div>
                 <div class="flex justify-between border-b border-dashed border-gray-200 pb-2"> <span class="text-gray-500">Sumber</span> <span class="font-bold text-dark">${sourceName}</span> </div>
                 <div class="flex justify-between border-b border-dashed border-gray-200 pb-2"> <span class="text-gray-500">Tujuan</span> <span class="font-bold text-dark">${destName}</span> </div>
                 <div class="flex justify-between pb-1"> <span class="text-gray-500">ID</span> <span class="font-mono text-[10px] text-gray-400">${tx.id}</span> </div>
            </div>
        `;
        document.getElementById('detail-tx-content').innerHTML = detailHtml;
        openModal('modal-detail-tx');
    }

    // --- 6. FILTER & ACTIONS ---
    function openFilter() { openModal('modal-filter'); }
    function toggleCustomDate() { const v=document.getElementById('filter-time').value; const a=document.getElementById('custom-date-area'); if(v==='custom') a.classList.remove('hidden'); else a.classList.add('hidden'); }
    function applyFilter() {
        const type = document.getElementById('filter-type').value;
        const time = document.getElementById('filter-time').value;
        let filtered = appData.transactions;
        if(type !== 'all') filtered = filtered.filter(t => t.type === type);
        const now = new Date();
        if(time === 'this_month') filtered = filtered.filter(t => new Date(t.date).getMonth() === now.getMonth() && new Date(t.date).getFullYear() === now.getFullYear());
        else if (time === 'last_month') { const last=new Date(); last.setMonth(now.getMonth()-1); filtered=filtered.filter(t=>new Date(t.date).getMonth()===last.getMonth()); }
        else if (time === 'custom') {
            const s=document.getElementById('filter-start').value; const e=document.getElementById('filter-end').value;
            if(s&&e) { const sd=new Date(s); sd.setHours(0,0,0,0); const ed=new Date(e); ed.setHours(23,59,59,999); filtered=filtered.filter(t=>{const d=new Date(t.date); return d>=sd && d<=ed;}); }
        }
        activeTransactions = filtered; render(null); closeModal('modal-filter'); showToast(`${activeTransactions.length} Data`);
    }
    
    function openDownloadModal() { openModal('modal-download-opt'); }
    function downloadCSV() {
        if(activeTransactions.length===0){alert("Kosong");return;}
        let csv="Tanggal,Judul,Tipe,Jumlah\n"; activeTransactions.forEach(t=>{csv+=`${t.date},${t.title},${t.type},${t.amount}\n`});
        const a=document.createElement('a'); a.href=window.URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='Laporan.csv'; a.click(); closeModal('modal-download-opt');
    }
    function downloadImage() {
        if(activeTransactions.length===0){alert("Kosong");return;} showToast("Membuat Laporan...");
        let i=0,o=0; activeTransactions.forEach(t=>{if(t.type==='income')i+=t.amount;if(t.type==='expense')o+=t.amount;});
        document.getElementById('rep-in').innerText=formatIDR(i); document.getElementById('rep-out').innerText=formatIDR(o);
        document.getElementById('rep-print-date').innerText=new Date().toLocaleDateString('id-ID');
        document.getElementById('rep-list').innerHTML=activeTransactions.slice(0,30).map(t=>`<div class="flex justify-between border-b border-dashed border-gray-200 pb-2 mb-2"><div class="pr-2"><p class="font-bold text-gray-700 text-xs">${t.title}</p><p class="text-[10px] text-gray-400">${formatDate(t.date)}</p></div><p class="font-bold text-xs ${t.type==='income'?'text-green-600':(t.type==='expense'?'text-red-600':'text-dark')}">${t.type==='income'?'+':(t.type==='expense'?'-':'')}${formatIDR(t.amount)}</p></div>`).join('');
        setTimeout(()=>{ html2canvas(document.getElementById('report-render-area'),{scale:2}).then(c=>{const a=document.createElement('a'); a.href=c.toDataURL('image/png'); a.download=`Laporan_${Date.now()}.png`; a.click(); closeModal('modal-download-opt'); showToast("Gambar Disimpan");}); },800);
    }

    // --- 7. MODALS ---
    function openModal(id) { document.getElementById(id).classList.remove('modal-enter'); document.getElementById(id).classList.add('modal-active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('modal-active'); document.getElementById(id).classList.add('modal-enter'); }
    // Openers
    function openIncomeModal(bid) { if(!appData.banks.length){alert("Buat Bank dulu");navigateTo('banks');return;} openModal('modal-income'); const s=document.getElementById('inc-bank-target'); s.innerHTML=appData.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join(''); if(bid)s.value=bid; document.getElementById('inc-amount').value=''; }
    function openAlokasiModal(sid) { openModal('modal-alokasi'); document.getElementById('alo-from-id').innerHTML=appData.banks.map(b=>`<option value="${b.id}">${b.name}</option>`).join(''); if(sid)document.getElementById('alo-from-id').value=sid; document.getElementById('alo-to-id').innerHTML=appData.dompets.map(d=>`<option value="${d.id}">${d.name}</option>`).join(''); document.getElementById('alo-amount').value=''; }
    function openTopUpDompet(did) { openAlokasiModal(); document.getElementById('alo-to-id').value=did; }
    function openPindahDompet(did) { openModal('modal-alokasi'); document.getElementById('alo-from-id').innerHTML=appData.dompets.map(d=>`<option value="${d.id}">${d.name}</option>`).join(''); document.getElementById('alo-from-id').value=did; document.getElementById('alo-to-id').innerHTML=appData.dompets.filter(d=>d.id!==did).map(d=>`<option value="${d.id}">${d.name}</option>`).join(''); document.getElementById('alo-amount').value=''; }
    function openExpenseModal(did) { openModal('modal-expense'); const d=appData.dompets.find(x=>x.id===did); document.getElementById('exp-from-name').innerText=d.name; document.getElementById('exp-from-bal').innerText=formatIDR(d.balance); document.getElementById('exp-from-id').value=did; document.getElementById('exp-amount').value=''; }
    function openAddModal(t) { document.getElementById('entity-type').value=t; document.getElementById('modal-entity-title').innerText=t==='bank'?'Tambah Bank':'Tambah Dompet'; openModal('modal-add-entity'); document.getElementById('entity-balance').value=''; }
    function toggleDrawer(o) { const ov=document.getElementById('drawer-overlay'), m=document.getElementById('drawer-menu'); if(o){ ov.classList.remove('hidden'); setTimeout(()=>ov.classList.remove('opacity-0'),10); m.classList.remove('-translate-x-full'); } else { ov.classList.add('opacity-0'); m.classList.add('-translate-x-full'); setTimeout(()=>ov.classList.add('hidden'),300); } }
    
    // Submits
    function handleSubmitIncome(e) { e.preventDefault(); const d=document.getElementById('inc-date').value, amt=cleanCurrency(document.getElementById('inc-amount').value); processTransaction(document.getElementById('inc-name').value, amt, 'income', null, document.getElementById('inc-bank-target').value, null, d?new Date(d).toISOString():new Date().toISOString()); closeModal('modal-income'); e.target.reset(); showToast("Disimpan"); }
    function handleSubmitAlokasi(e) { e.preventDefault(); const d=document.getElementById('alo-date').value, amt=cleanCurrency(document.getElementById('alo-amount').value); processTransaction('Pindah Dana', amt, 'transfer', document.getElementById('alo-from-id').value, document.getElementById('alo-to-id').value, null, d?new Date(d).toISOString():new Date().toISOString()); closeModal('modal-alokasi'); e.target.reset(); showToast("Berhasil"); }
    function handleSubmitExpense(e) { e.preventDefault(); const d=document.getElementById('exp-date').value, amt=cleanCurrency(document.getElementById('exp-amount').value); processTransaction(document.getElementById('exp-title').value, amt, 'expense', document.getElementById('exp-from-id').value, null, null, d?new Date(d).toISOString():new Date().toISOString()); closeModal('modal-expense'); e.target.reset(); showToast("Terbayar"); }
    function handleAddEntity(e) { e.preventDefault(); const amt=cleanCurrency(document.getElementById('entity-balance').value); createEntity(document.getElementById('entity-type').value, document.getElementById('entity-name').value, amt); closeModal('modal-add-entity'); e.target.reset(); }
    
    function openAIModal() { openModal('modal-ai'); document.getElementById('ai-content').innerHTML=`<div class="text-center py-8"><i class="ph ph-sparkle text-4xl text-magic mb-4 animate-pulse"></i><h3 class="font-bold text-lg">Analisis AI</h3><p class="text-xs text-gray-500 mt-2">Total Harta: ${formatIDR(appData.banks.reduce((a,b)=>a+b.balance,0)+appData.dompets.reduce((a,b)=>a+b.balance,0))}</p></div>`; }

    window.onload = () => navigateTo('dashboard');
</script>
</body>
</html>
